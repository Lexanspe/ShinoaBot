const { SlashCommandBuilder, EmbedBuilder } = require('discord.js');
const { joinVoiceChannel, createAudioPlayer, createAudioResource, AudioPlayerStatus } = require('@discordjs/voice');
const fs = require('fs');
const path = require('path');

const guildEmbeds = new Map(); 

module.exports = {
    data: new SlashCommandBuilder()
        .setName('voice')
        .setDescription('Voice channel management commands'),


async execute(interaction) {

    // KullanÄ±cÄ±nÄ±n ses kanalÄ±nda olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    const userVoiceChannel = interaction.member.voice.channel;
    
    if (!userVoiceChannel) {
        const notInVoiceEmbed = new EmbedBuilder()
            .setColor('#ff0000')
            .setTitle('âŒ Ses KanalÄ±nda DeÄŸilsin!')
            .setDescription('Bu komutu kullanmak iÃ§in Ã¶nce bir ses kanalÄ±na katÄ±lman gerekiyor.')
            .setFooter({ text: 'ShinoaBot', iconURL: interaction.client.user.displayAvatarURL() })
            .setTimestamp();
            
        return interaction.reply({ embeds: [notInVoiceEmbed], ephemeral: true });
    }

    async function updateEmbed() {

        embed = new EmbedBuilder()
            .setColor('#00ff00')
            .setTitle('ğŸµ MÃ¼zik Ã‡alÄ±nÄ±yor!')
            .setDescription(`**${userVoiceChannel.name}** kanalÄ±na katÄ±ldÄ±m ve mÃ¼zik Ã§almaya baÅŸladÄ±m!`)
            .addFields(
                { name: 'ğŸ”Š Kanal', value: userVoiceChannel.name, inline: true },
                { name: 'ğŸ‘¥ Ãœye SayÄ±sÄ±', value: `${userVoiceChannel.members.size}`, inline: true },
                { name: 'ğŸµ Ã‡alan ÅarkÄ±', value: randomSong.replace('.mp3', ''), inline: false }
            )
            .setFooter({ text: 'ShinoaBot', iconURL: interaction.client.user.displayAvatarURL() })
            .setTimestamp();

        await msg.edit({ embeds: [embed] });
    }

    try {
        // Ses kanalÄ±na katÄ±l
        const connection = joinVoiceChannel({
            channelId: userVoiceChannel.id,
            guildId: interaction.guild.id,
            adapterCreator: interaction.guild.voiceAdapterCreator,
        });

        // Songs klasÃ¶rÃ¼ndeki dosyalarÄ± al
        const songsPath = path.join(__dirname, '..', 'songs');
        const songFiles = fs.readdirSync(songsPath).filter(file => file.endsWith('.mp3'));
        
        if (songFiles.length === 0) {
            return interaction.reply({ content: 'HiÃ§ mÃ¼zik dosyasÄ± bulunamadÄ±!', ephemeral: true });
        }
     
        // Audio player ve resource oluÅŸtur
        const player = createAudioPlayer();
        
        // Player'Ä± connection'a subscribe et
        connection.subscribe(player);

        embed = new EmbedBuilder()
        .setColor('#54007f')
        .setTitle('idunno')
        .setDescription(desc)
        .setFooter(footer);

        const msg = await interaction.reply({ embeds: [embed], fetchReply: true });

        // Player durumunu izle
        player.on(AudioPlayerStatus.Playing, () => {
            console.log(`Playing: ${randomSong} in ${userVoiceChannel.name}`);
        });

        player.on(AudioPlayerStatus.Idle, () => {
            console.log(`Finished playing: ${randomSong}`);
            connection.destroy(); // ÅarkÄ± bitince baÄŸlantÄ±yÄ± kes
        });

        player.on('error', error => {
            console.error('Audio player error:', error);
            connection.destroy();
        });

    } catch (error) {
        console.error('Voice connection error:', error);
        
        const errorEmbed = new EmbedBuilder()
            .setColor('#ff0000')
            .setTitle('âŒ Hata!')
            .setDescription('Ses kanalÄ±na katÄ±lÄ±rken veya mÃ¼zik Ã§alarken bir hata oluÅŸtu.')
            .setFooter({ text: 'ShinoaBot', iconURL: interaction.client.user.displayAvatarURL() })
            .setTimestamp();
            
        return interaction.reply({ embeds: [errorEmbed], ephemeral: true });
    }

}
};